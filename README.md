# Citrix-PVS-deploy-image

## Описание

Данный скрипт предназначен для автоматизации процесса тиражирования образов Citrix PVS на виртуальные машины.
Скрипт написан для инфраструктуры с 2-мя ЦОД, количество серверов в каждом ЦОД не важно.
Его необходимо запускать на сервере PVS к которому привязаны образы в режиме правки.
Каждый образ привязывается ко всем виртуальным машинам нужной коллекции или нескольким коллекциям.
#### Если у вас в одной коллекции к виртуальным машинам привязываются разные образы, то необходимо разделение этих устройств на разные коллекции!!!
Скрипт загружает данные из заранее подготовленного файла "Setting.xml", далее подключается к локальному серверу PVS при помощи модуля "Citrix.PVS.SnapIn.dll".
1) Он проверяет device dollection с виртуальными машинами для внесения изменений в образы.
2) Если виртуальная машина выключена или образ подключенный к ней в стандартом режиме он пропускает ее. Если она включена и подключенный образ в режиме правки, то через Invoke-Command (PowerShell Remoting) создает задания (jobs). В данных заданиях на виртуальных машинах запускается скрипт для удаления сертификатов SCOM и SCCM, кэш SCCM, удаляется ключ в реестре 120-ти дневного льготного периода RDS и сохраненные профиля пользователей кроме системных и текущего пользователя. Так же он останавливает и отключает службу Windows Update, выключает виртуальную машину.
3) Дождавшись, что виртуальные машины выключены он меняет режим диска на стандартный с записью кэша в оперативную память и на диск, размер кэша устанавливается 4096 МБ. Если образы заблокированы одной виртуальной машиной то предполагается, что это виртуальная машина для изменения образа или тестовая машина и блокировка снимается. Если образ заблокирован большим числом виртуальных машин, то образ пропускается и выводится соответствующее сообщение с именами машин.
5) Далее выполняется копирование образов на все PVS серверы при помощи Robocopy, для каждого сервера PVS создается отдельный системный процесс для параллельного копирования, но каждый образ копируется последовательно, чтобы процессы не утилизировали все ресурсы ОЗУ.
6) После копирования образов они добавляются в хранилище образов PVS во 2-ом ЦОД.
7) Выполняется привязка образов к device dollections согласно ассоциации коллекций устройств с хранилищами образов в файле "Setting.xml". 

## Файл Setting.xml

В данном файле необходимо заполнить поля:
1) Ассоциации Store и Device Collection, образ из данного хранилища будет привязан ко всем виртуальным машинам в коллекции. 
Пример: 
   <Associated_Stores>
      <Store>Store Name</Store>
      <DeviceCollection>Имя Device Collection</DeviceCollection>
   </Associated_Stores>
Если образ привязывается к нескольким коллекциям, просто перечислите их через запятую.
Пример:
   <DeviceCollection>Device-Collection-01, Device-Collection-02, Device-Collection-03</DeviceCollection>
Для добавления ассоциаций просо скопируйте тег <Associated_Stores> </Associated_Stores> далее изминте Store Name и Device Collection Name.
Пример:
   <Associated_Stores>
			<Store>Store Name</Store>
			<DeviceCollection>Device Collection Name</DeviceCollection>
	 </Associated_Stores>
   
2) Тег < Domain >, укажите имя домена вашей организации.
   
3) Тег <WR_DeviceCollection>, нужно указать имя Device Collection где расположены виртуальные машины для подключения образов в режиме правки (private).
Именно в этой коллекции будет выполнятся поиск образов в private режиме привязанных к виртуальным машинам в ней для последующего тиражирования.
Пример: 
   <WR_DeviceCollection>Device Collection Name</WR_DeviceCollection>
   
4) Теги <ServersPVS_COD1> и <ServersPVS_COD2> в них нужно перечислить через запятую серверы PVS каждого ЦОД соответственно.
Пример:
   <ServersPVS_COD1>pvs-01, pvs-02, pvs-03</ServersPVS_COD1>
   <ServersPVS_COD2>pvs-21, pvs-22, pvs-23</ServersPVS_COD2>
   
5) Тег < SiteName >, указывается имя сайта в ферме PVS, имя сайта можно увидеть в консоли PVS.


