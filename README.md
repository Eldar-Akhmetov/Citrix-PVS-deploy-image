# Citrix-PVS-deploy-image

## Описание

Данный скрипт предназначен для автоматизации процесса тиражирования образов Citrix PVS на виртуальные машины.
Скрипт написан для инфраструктуры с 2-мя ЦОД, количество серверов в каждом ЦОД не важно.
Его необходимо запускать на сервере PVS к которому привязаны образы в режиме правки.
Скрипт загружает данные из заранее подготовленного файла "Setting.xml", далее подключается к локальному серверу PVS при помощи модуля "Citrix.PVS.SnapIn.dll".
1) Он проверяет device dollection с виртуальными машинами для внесения изменений в образы.
2) Если образ подключенный к виртуальной машине в стандартом режиме он пропускает ее, если в режиме правки, то через Invoke-Command (PowerShell Remoting) создает задания (jobs). В данных заданиях на виртуальных машинах запускается скрипт для удаления сертификатов SCOM и SCCM, кэш SCCM, удаляется ключ в реестре 120-ти дневного льготного периода RDS и сохраненные профиля пользователей кроме системных и текущего пользователя. Так же он останавливает и отключает службу Windows Update, выключает виртуальную машину.
3) Дождавшись, что виртуальные машины выключены он меняет режим диска на стандартный с записью кэша в оперативную память и на диск, размер кэша устанавливается 4096 МБ. Если образы заблокированы одной виртуальной машиной то предполается, что это виртуальная машина для изменения образа или тестовая машина и блокировка снимается. Если образ заблокирован большим числом виртуальных машин, то образ пропускается и выводится соответствующее сообщение с именами машин.
5) Далее выполняется копирование образов на все PVS серверы при помощи Robocopy, для каждого сервера PVS создается отдельный системный процесс для параллельного копирования, но каждый образ копируется последовательно, чтобы процессы не утилизировали все ресурсы ОЗУ.
6) После копирования образов они добавляются в хранилище образов PVS во 2-ом ЦОД.
7) Выполняется привязка образов к device dollections согласно ассоциации коллекций устройств с хранилищами образов в файле "Setting.xml". 
